<!DOCTYPE HTML>
{% load static %}
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="pragma" content="no-cache" />
	<meta http-equiv="cache-control" content="max-age=604800" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>FreshFoods</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<!-- Dynamic Theme Stylesheet -->
	<link id="theme-stylesheet" rel="stylesheet" href="{% static 'css/light.css' %}">

	<link href="{% static 'css/theme.min.css' %}" rel="stylesheet" type="text/css" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll@16.1.3/dist/smooth-scroll.polyfills.min.js"></script>
	<script src="{% static 'js/theme.min.js' %}"></script>

	<style>
		/* üî• Dark Mode Toggle Button */
        #theme-toggle {
            position: fixed;
            bottom: 20px; /* Changed position to bottom-left */
            left: 20px;
            padding: 10px;
            border-radius: 10px;
            background: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
            font-size: 16px;
            z-index: 9999;
        }

        /* üìå Chatbox Styling */
        #chat-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-window {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            padding: 15px;
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 250px;
            transition: all 0.3s ease-in-out;
        }
	</style>
</head>

<body>

<!-- üåô Dark Mode Toggle Button -->
<button onclick="toggleTheme()" id="theme-toggle">üåô Dark Mode</button>

{% include "header.html" %}
{% include "sidebar.html" %}
{% block content %}{% endblock %}

<!-- üí¨ Floating Chat Assistant -->
<div id="chat-box">
	<button onclick="toggleChat()" class="btn btn-primary">üí¨ Chat with us</button>
	<div id="chat-window">
		<p><strong>Support:</strong> How can we help you today?</p>
		<input type="text" id="chat-input" placeholder="Type a message...">
		<button onclick="sendMessage()" class="btn btn-success">Send</button>
		<button onclick="closeChat()" class="btn btn-danger">Close</button>
	</div>
</div>

<script>
	// üåô Dark Mode Toggle Function (Fixes CSS Loading Issue)
    function toggleTheme() {
        let currentTheme = localStorage.getItem("theme") || "light";
        let newTheme = currentTheme === "light" ? "dark" : "light";

        // Dynamically set the correct path for CSS files
        document.getElementById("theme-stylesheet").setAttribute("href", `/static/css/${newTheme}.css`);
        localStorage.setItem("theme", newTheme);

        let toggleButton = document.getElementById("theme-toggle");
        if (toggleButton) {
            toggleButton.textContent = newTheme === "light" ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
        }
    }

    // Load saved theme on page load
    window.onload = function () {
        let savedTheme = localStorage.getItem("theme") || "light";
        document.getElementById("theme-stylesheet").setAttribute("href", `/static/css/${savedTheme}.css`);

        let toggleButton = document.getElementById("theme-toggle");
        if (toggleButton) {
            toggleButton.textContent = savedTheme === "light" ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
        }
    };

    // üí¨ Fix Chatbox Toggle Issue
    function toggleChat() {
        let chatWindow = document.getElementById("chat-window");
        chatWindow.style.display = chatWindow.style.display === "none" || chatWindow.style.display === "" ? "block" : "none";
    }

    function closeChat() {
        document.getElementById("chat-window").style.display = "none";
    }

    function sendMessage() {
        let message = document.getElementById("chat-input").value;
        if (message.trim() === "") return; // Avoid sending empty messages

        chatSocket.send(JSON.stringify({ "message": message }));

        let chatWindow = document.getElementById("chat-window");

        // Append new message inside chat window properly
        let newMessage = document.createElement("p");
        newMessage.textContent = "You: " + message;
        chatWindow.appendChild(newMessage);

        document.getElementById("chat-input").value = "";
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // üî• WebSocket Setup (Improves Stability & Prevents Connection Errors)
    let chatSocket;
    function initializeWebSocket() {
        chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/");

        chatSocket.onmessage = function (event) {
            let data = JSON.parse(event.data);
            let chatWindow = document.getElementById("chat-window");

            // Ensure messages are properly appended without duplication
            let newMessage = document.createElement("p");
            newMessage.textContent = "Support: " + data.message;
            chatWindow.appendChild(newMessage);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        chatSocket.onerror = function () {
            console.error("WebSocket encountered an error. Reconnecting...");
            setTimeout(initializeWebSocket, 3000); // Auto-reconnect WebSocket every 3 seconds if it fails
        };
    }

    initializeWebSocket();
</script>

</body>
</html>
